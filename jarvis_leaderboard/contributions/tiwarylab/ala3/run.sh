#!/bin/bash
#SBATCH -t 24:00:00
#SBATCH -n 16
#SBATCH -N 1
#SBATCH -A tiwary-prj-paid
#SBATCH -p standard
#SBATCH --job-name="md"

protname="sys"
module load gromacs/2021.4

echo $SLURM_NTASKS
# production run
MAX_TIME=24
cycles=10
NAME="pro"
############################################################################
# Run
############################################################################
if [ -e runno ] ; then
   #########################################################################
   # Restart runs
   #########################################################################
   nn=`tail -n 1 runno | awk '{print $1}'`
   mpirun -n $SLURM_NTASKS gmx_mpi mdrun -maxh ${MAX_TIME} -cpi ${NAME}.cpt -deffnm ${NAME} -ntomp 1 -append
   #########################################################################
else
   #########################################################################
   # First run
   #########################################################################
   nn=1
   mpirun -n $SLURM_NTASKS gmx_mpi mdrun -maxh ${MAX_TIME} -deffnm ${NAME} -ntomp 1
   #########################################################################
fi
############################################################################


############################################################################
# Check number of cycles
############################################################################
mm=$((nn+1))
echo ${mm} > runno
#cheking number of cycles
if [ ${nn} -ge ${cycles} ]; then
  exit
fi
############################################################################

############################################################################
# Resubmitting again
############################################################################
sbatch < run.sh
